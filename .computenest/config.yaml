Service:
  DeployType: ros
  DeployMetadata:
    SupplierDeployMetadata:
      ArtifactRelation:
        centos_7_9_x64_20G_alibase_20240403.vhd:
          ArtifactId: ${Artifact.EcsImage.ArtifactId}
          ArtifactVersion: draft
      SupplierTemplateConfigs:
        - Name: å•æœºç‰ˆ
          Url: ros_templates/template.yaml
          PredefinedParameters: []
          AllowedRegions:
            - ap-southeast-1
    TemplateConfigs:
      - Name: å•æœºç‰ˆ
        Url: ros_templates/template.yaml
        PredefinedParameters: []
        AllowedRegions:
          - ap-southeast-1
    NetworkMetadata:
      EnablePrivateVpcConnection: false
      EnableReversePrivateVpcConnection: false
    ServiceInstanceNameRule:
      Prefix: Vespa
      UseDefaultValue: false
  OperationMetadata:
    SupportBackup: false
    PrometheusConfigMap:
      å•æœºç‰ˆ:
        EnablePrometheus: false
  ServiceType: private
  ServiceInfo:
    Locale: zh-CN
    ShortDescription: "Vespa æ˜¯ä¸€ä¸ªå¼€æºã€å¤§è§„æ¨¡ã€å®žæ—¶ AI/æœç´¢ä¸ŽæŽ¨èå¼•æ“Žã€‚å®ƒä¸“ä¸º ä½Žå»¶è¿Ÿã€é«˜åžåã€å¤æ‚æŽ’åºå’Œå‘é‡æ£€ç´¢ åœºæ™¯è®¾è®¡ï¼Œå¹¿æ³›åº”ç”¨äºŽæœç´¢ã€æŽ¨èã€å¹¿å‘Šã€è¯­ä¹‰åŒ¹é…ç­‰åœºæ™¯ã€‚"
    Image: resources/icons/service_logo.png
    Name: Vespaç¤¾åŒºç‰ˆ
  ShareType: Public
  ApprovalType: Manual
Artifact:
  EcsImage:
    ArtifactType: EcsImage
    ArtifactName: Vespa
    Description: Vespa
    SupportRegionIds:
        - ap-southeast-1
    ArtifactBuildProperty:
      CodeRepo:
        Platform: github
        Owner: LYH-RAIN
        RepoName: aliyun-computenest/quickstart-vespa
        Branch: main
      RegionId: ap-southeast-1
      CommandType: RunShellScript
      CommandContent: |-
        #!/bin/bash
        # å‡çº§åŸºç¡€ç»„ä»¶ï¼š

        # --- 1. åˆ›å»ºé¡¹ç›®ç›®å½• ---
        echo "ðŸ“ åˆ›å»ºç›®å½•ç»“æž„..."
        if ! mkdir -p "$APP_DIR" "$DATA_DIR/var" "$DATA_DIR/logs"; then
          echo "âŒ æ— æ³•åˆ›å»ºç›®å½•ï¼Œè¯·æ£€æŸ¥å½“å‰è·¯å¾„æ˜¯å¦æœ‰å†™æƒé™ã€‚"
          exit 1
        fi

        # éªŒè¯ç›®å½•æ˜¯å¦å­˜åœ¨
        if [ ! -d "$APP_DIR" ]; then
          echo "âŒ ç›®å½• $APP_DIR åˆ›å»ºå¤±è´¥ï¼"
          exit 1
        fi

        # å®‰è£…Docker
        yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
        yum makecache
        yum install -y curl git docker-ce
        sudo systemctl enable --now docker.socket
        sudo systemctl enable --now docker.service

        # --- 2. ç”Ÿæˆ services.xml ---
        echo "ðŸ“ ç”Ÿæˆæœ€å°åº”ç”¨é…ç½®..."
        cat > "$APP_DIR/services.xml" <<EOF
        <?xml version="1.0" encoding="utf-8" ?>
        <services version="1.0">
          <container id="default" version="1.0">
            <search />
            <document-api />
            <nodes>
              <node hostalias="node1" />
            </nodes>
          </container>
        </services>
        EOF

        # éªŒè¯æ–‡ä»¶æ˜¯å¦å†™å…¥
        if [ ! -f "$APP_DIR/services.xml" ]; then
          echo "âŒ æ— æ³•å†™å…¥ $APP_DIR/services.xmlï¼Œè¯·æ£€æŸ¥ç£ç›˜ç©ºé—´æˆ–æƒé™ã€‚"
          exit 1
        fi

        # --- 3. åˆ›å»º init è„šæœ¬ ---
        echo "âš™ï¸  åˆ›å»ºåˆå§‹åŒ–è„šæœ¬..."
        cat > "$PROJECT_DIR/init-vespa.sh" <<'EOF'
        #!/bin/bash
        set -e
        echo "â³ Waiting for Vespa Config Server to be ready..."
        timeout=60
        while ! curl -s http://vespa:19071/application/v2/tenant/default > /dev/null; do
          if ((timeout <= 0)); then
            echo "âŒ Config server failed to start in time."
            exit 1
          fi
          echo "   Config server not ready... (waiting ${timeout}s)"
          sleep 5
          ((timeout -= 5))
        done
        echo "âœ… Config server is ready. Deploying application..."
        rm -rf /tmp/app
        cp -r /app /tmp/app
        /opt/vespa/bin/vespa-deploy prepare /tmp/app
        /opt/vespa/bin/vespa-deploy activate
        echo "ðŸš€ Application deployed successfully!"
        exit 0
        EOF

        chmod +x "$PROJECT_DIR/init-vespa.sh"

        # --- 4. åˆ›å»º docker-compose.yml ---
        echo "ðŸ³ ç”Ÿæˆ docker-compose.yml..."
        cat > "$PROJECT_DIR/docker-compose.yml" <<EOF
        version: '3.8'

        services:
          vespa:
            image: vespaengine/vespa:latest
            container_name: vespa
            hostname: vespa-container
            ports:
              - "8080:8080"
              - "19071:19071"
            volumes:
              - ./vespa_var:/opt/vespa/var
              - ./vespa_logs:/opt/vespa/logs
            environment:
              VESPA_VAR_STORAGE: /opt/vespa/var
              VESPA_LOG_STORAGE: /opt/vespa/logs
              VESPA_CONFIGSERVERS: vespa-container
            restart: unless-stopped

        EOF

        # --- 5. å¯åŠ¨æœåŠ¡ ---
        cd "$PROJECT_DIR"
        echo "ðŸš€ å¯åŠ¨ Docker Compose..."
        mkdir -p vespa_var vespa_logs

        # æŽˆæƒï¼ˆå¼€å‘çŽ¯å¢ƒç”¨ chmod æ›´ç®€å•ï¼‰
        chmod -R a+w vespa_var vespa_logs

        if ! docker compose up -d; then
          echo "âŒ Docker Compose å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²å®‰è£… docker å’Œ docker-composeã€‚"
          exit 1
        fi

        # --- 6. éªŒè¯ ---
        echo "ðŸ” ç­‰å¾…æœåŠ¡å°±ç»ªï¼ˆçº¦30ç§’ï¼‰..."
        until curl -s http://localhost:19071/application/v2/tenant/default; do sleep 5; done
        docker cp application/. vespa:/tmp/app
        docker exec vespa sh -c "
          /opt/vespa/bin/vespa-deploy prepare /tmp/app &&
          /opt/vespa/bin/vespa-deploy activate
        "
        echo "âœ… Done!"
